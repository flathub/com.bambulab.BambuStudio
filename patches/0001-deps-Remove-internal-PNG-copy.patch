From cf358b6a5c5f32fce09b0446c67ad1b575fdc861 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Tue, 19 Dec 2023 12:33:35 +0100
Subject: [PATCH] deps: Remove internal PNG copy

And use the system one instead.
---
 deps/CMakeLists.txt |  6 ------
 deps/PNG/PNG.cmake  | 31 -------------------------------
 deps/PNG/PNG.patch  | 26 --------------------------
 3 files changed, 63 deletions(-)
 delete mode 100644 deps/PNG/PNG.cmake
 delete mode 100644 deps/PNG/PNG.patch

diff --git a/deps/CMakeLists.txt b/deps/CMakeLists.txt
index 4d762a524a84..e143b999d6dc 100644
--- a/deps/CMakeLists.txt
+++ b/deps/CMakeLists.txt
@@ -147,11 +147,6 @@ if (NOT ZLIB_FOUND)
     include(ZLIB/ZLIB.cmake)
     set(ZLIB_PKG dep_ZLIB)
 endif ()
-set(PNG_PKG "")
-if (NOT PNG_FOUND) 
-    include(PNG/PNG.cmake)
-    set(PNG_PKG dep_PNG)
-endif ()
 set(EXPAT_PKG "")
 if (NOT EXPAT_FOUND) 
     include(EXPAT/EXPAT.cmake)
@@ -206,7 +201,6 @@ set(_dep_list
     dep_CGAL
     dep_OpenSSL
     dep_GLFW
-    ${PNG_PKG}
     ${ZLIB_PKG}
     ${EXPAT_PKG}
     )
diff --git a/deps/PNG/PNG.cmake b/deps/PNG/PNG.cmake
deleted file mode 100644
index 3dca778756ec..000000000000
--- a/deps/PNG/PNG.cmake
+++ /dev/null
@@ -1,31 +0,0 @@
-if (APPLE)
-    # Only disable NEON extension for Apple ARM builds, leave it enabled for Raspberry PI.
-    set(_disable_neon_extension "-DPNG_ARM_NEON=off")
-else ()
-    set(_disable_neon_extension "")
-endif ()
-
-set(_patch_step "")
-if (APPLE)
-    set(_patch_step PATCH_COMMAND ${PATCH_CMD} ${CMAKE_CURRENT_LIST_DIR}/PNG.patch)
-endif ()
-
-bambustudio_add_cmake_project(PNG 
-    # GIT_REPOSITORY https://github.com/glennrp/libpng.git 
-    # GIT_TAG v1.6.35
-    URL https://github.com/glennrp/libpng/archive/refs/tags/v1.6.35.zip
-    URL_HASH SHA256=3d22d46c566b1761a0e15ea397589b3a5f36ac09b7c785382e6470156c04247f
-    DEPENDS ${ZLIB_PKG}
-    "${_patch_step}"
-    CMAKE_ARGS
-        -DPNG_SHARED=OFF
-        -DPNG_STATIC=ON
-        -DPNG_PREFIX=prusaslicer_
-        -DPNG_TESTS=OFF
-        -DDISABLE_DEPENDENCY_TRACKING=OFF
-        ${_disable_neon_extension}
-)
-
-if (MSVC)
-    add_debug_dep(dep_PNG)
-endif ()
diff --git a/deps/PNG/PNG.patch b/deps/PNG/PNG.patch
deleted file mode 100644
index 3e6a70d519e2..000000000000
--- a/deps/PNG/PNG.patch
+++ /dev/null
@@ -1,26 +0,0 @@
-Common subdirectories: ../libpng-1.6.35-orig/arm and ./arm
-Common subdirectories: ../libpng-1.6.35-orig/contrib and ./contrib
-Common subdirectories: ../libpng-1.6.35-orig/intel and ./intel
-Common subdirectories: ../libpng-1.6.35-orig/mips and ./mips
-Only in ./: PNG.patch
-diff -u ../libpng-1.6.35-orig/pngrutil.c ./pngrutil.c
---- ../libpng-1.6.35-orig/pngrutil.c	2018-07-15 20:58:00.000000000 +0200
-+++ ./pngrutil.c	2021-03-24 15:59:38.687108444 +0100
-@@ -422,13 +422,6 @@
-             png_ptr->flags |= PNG_FLAG_ZSTREAM_INITIALIZED;
-       }
- 
--#if ZLIB_VERNUM >= 0x1290 && \
--   defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)
--      if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)
--         /* Turn off validation of the ADLER32 checksum in IDAT chunks */
--         ret = inflateValidate(&png_ptr->zstream, 0);
--#endif
--
-       if (ret == Z_OK)
-          png_ptr->zowner = owner;
- 
-Common subdirectories: ../libpng-1.6.35-orig/powerpc and ./powerpc
-Common subdirectories: ../libpng-1.6.35-orig/projects and ./projects
-Common subdirectories: ../libpng-1.6.35-orig/scripts and ./scripts
-Common subdirectories: ../libpng-1.6.35-orig/tests and ./tests
-- 
2.43.0

